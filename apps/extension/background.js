var w=Object.defineProperty;var E=(o,e,t)=>e in o?w(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var h=(o,e,t)=>E(o,typeof e!="symbol"?e+"":e,t);const b="modulepreload",k=function(o){return"/"+o},m={},T=function(e,t,r){let a=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const s=document.querySelector("meta[property=csp-nonce]"),n=(s==null?void 0:s.nonce)||(s==null?void 0:s.getAttribute("nonce"));a=Promise.allSettled(t.map(i=>{if(i=k(i),i in m)return;m[i]=!0;const l=i.endsWith(".css"),p=l?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${i}"]${p}`))return;const u=document.createElement("link");if(u.rel=l?"stylesheet":b,l||(u.as="script"),u.crossOrigin="",u.href=i,n&&u.setAttribute("nonce",n),document.head.appendChild(u),l)return new Promise((g,d)=>{u.addEventListener("load",g),u.addEventListener("error",()=>d(new Error(`Unable to preload CSS for ${i}`)))})}))}function c(s){const n=new Event("vite:preloadError",{cancelable:!0});if(n.payload=s,window.dispatchEvent(n),!n.defaultPrevented)throw s}return a.then(s=>{for(const n of s||[])n.status==="rejected"&&c(n.reason);return e().catch(c)})};class A{constructor(e,t){this.storage=e,this.api=t}async handle(e,t){switch(e.type){case"GET_PREFERENCES":return this.getPreferences();case"SET_PREFERENCES":return this.setPreferences(e.payload);case"TRANSLATE":return this.translate(e.payload);case"ROMANIZE":return this.romanize(e.payload);case"GET_YT_CAPTION_TRACKS":return this.getYtCaptionTracks(t);case"FETCH_YT_SUBTITLES":return this.fetchYtSubtitles(t,e.payload);case"GOOGLE_TRANSLATE":return this.googleTranslate(e.payload);case"SAVE_VOCABULARY":return this.saveVocabulary(e.payload);case"GET_VOCABULARY":return this.getVocabulary(e.payload);default:return{success:!1,error:`Unknown message type: ${e.type}`}}}async getYtCaptionTracks(e){var r,a;const t=(r=e.tab)==null?void 0:r.id;if(!t)return{success:!1,error:"No tab ID"};try{const c=await chrome.scripting.executeScript({target:{tabId:t},world:"MAIN",func:()=>{var l,p,u,g;const n=document.getElementById("movie_player");if(n!=null&&n.getPlayerResponse)try{const d=n.getPlayerResponse();if((p=(l=d==null?void 0:d.captions)==null?void 0:l.playerCaptionsTracklistRenderer)!=null&&p.captionTracks)return d.captions.playerCaptionsTracklistRenderer.captionTracks}catch{}const i=window.ytInitialPlayerResponse;return(g=(u=i==null?void 0:i.captions)==null?void 0:u.playerCaptionsTracklistRenderer)!=null&&g.captionTracks?i.captions.playerCaptionsTracklistRenderer.captionTracks:null}}),s=(a=c==null?void 0:c[0])==null?void 0:a.result;return s&&s.length>0?(console.log("[Background] Got",s.length,"caption tracks from MAIN world"),{success:!0,data:s}):{success:!1,error:"No caption tracks found"}}catch(c){return console.error("[Background] executeScript error:",c),{success:!1,error:c.message}}}async fetchYtSubtitles(e,t){var a,c;const r=(a=e.tab)==null?void 0:a.id;if(!r)return{success:!1,error:"No tab ID"};try{const s=await chrome.scripting.executeScript({target:{tabId:r},world:"MAIN",func:async i=>{try{return await(await fetch(i)).text()}catch{return null}},args:[t.url]}),n=(c=s==null?void 0:s[0])==null?void 0:c.result;return n&&n.length>0?(console.log("[Background] Fetched subtitle data:",n.length,"bytes"),{success:!0,data:{text:n}}):{success:!1,error:"Empty response from subtitle URL"}}catch(s){return console.error("[Background] executeScript fetch error:",s),{success:!1,error:s.message}}}async googleTranslate(e){try{const t=await fetch(e.url);if(t.status===429)return{success:!1,error:"RATE_LIMITED"};if(!t.ok)return{success:!1,error:`HTTP ${t.status}`};if(t.url&&t.url.includes("google.com/sorry"))return{success:!1,error:"RATE_LIMITED"};const r=await t.text();try{return{success:!0,data:JSON.parse(r)}}catch{return{success:!1,error:"RATE_LIMITED"}}}catch(t){const r=t.message||"";return r.includes("Failed to fetch")||r.includes("NetworkError")?{success:!1,error:"RATE_LIMITED"}:{success:!1,error:r}}}async getPreferences(){try{return{success:!0,data:await this.storage.getPreferences()}}catch(e){return{success:!1,error:e.message}}}async setPreferences(e){try{return await this.storage.setPreferences(e),{success:!0}}catch(t){return{success:!1,error:t.message}}}async translate(e){try{return{success:!0,data:await this.api.translate(e.text,e.targetLang)}}catch(t){return{success:!1,error:t.message}}}async romanize(e){try{return{success:!0,data:{...await this.api.romanize(e.text,e.language),source:"api"}}}catch(t){console.warn("[Background] API romanization failed, using local fallback:",t);try{const{romanizeWithSegments:r}=await T(async()=>{const{romanizeWithSegments:s}=await import("./chunks/index.CS-5At6T.js");return{romanizeWithSegments:s}},[]),a=r(e.text,{language:e.language}),c=/[\u4E00-\u9FFF]/.test(e.text);return c&&(e.language==="ja"||/[\u3040-\u309F\u30A0-\u30FF]/.test(e.text))&&console.warn("[Background] Japanese kanji detected but API unavailable. Kanji will not be romanized."),{success:!0,data:{romanized:a.romanized,segments:a.segments,source:"local",kanjiNotConverted:c&&e.language==="ja"}}}catch(r){return console.error("[Background] Local romanization failed:",r),{success:!0,data:{romanized:e.text,segments:[],source:"error"}}}}}async saveVocabulary(e){try{return{success:!0,data:await this.api.saveVocabulary(e)}}catch(t){return{success:!1,error:t.message}}}async getVocabulary(e){try{return{success:!0,data:await this.api.getVocabulary(e.language)}}catch(t){return{success:!1,error:t.message}}}}const f={languages:{fluentLanguages:["en"],targetLanguages:["ja"],primaryTarget:"ja",translationLanguage:"en",chineseVariant:"zh"},subtitles:{showOriginal:!0,showRomanization:!0,showTranslation:!0,romanizationSystem:"romaji-hepburn",fontSize:24,fontFamily:"system-ui, -apple-system, sans-serif",textColor:"#ffffff",backgroundColor:"rgba(0, 0, 0, 0.75)",position:"bottom",karaokeEnabled:!0,karaokeHighlightColor:"#fbbf24"},shortcuts:{toggleOverlay:"Alt+P",toggleRomanization:"Alt+R",toggleTranslation:"Alt+T",saveWord:"Alt+S"},theme:"system",autoPauseOnNewWord:!1,showDifficultyIndicators:!0};class P{constructor(){h(this,"cache",new Map)}async getPreferences(){const e=this.cache.get("preferences");if(e)return e;const r=(await chrome.storage.sync.get("preferences")).preferences||f;return this.cache.set("preferences",r),r}async setPreferences(e){const t=await this.getPreferences(),r=this.deepMerge(t,e);await chrome.storage.sync.set({preferences:r}),this.cache.set("preferences",r)}async setDefaultPreferences(){(await chrome.storage.sync.get("preferences")).preferences||(await chrome.storage.sync.set({preferences:f}),this.cache.set("preferences",f))}async get(e){const t=this.cache.get(e);if(t!==void 0)return t;const a=(await chrome.storage.local.get(e))[e]??null;return a!==null&&this.cache.set(e,a),a}async set(e,t){await chrome.storage.local.set({[e]:t}),this.cache.set(e,t)}clearCache(){this.cache.clear()}deepMerge(e,t){const r={...e},a=t;for(const c in a){const s=a[c],n=e[c];s&&typeof s=="object"&&!Array.isArray(s)&&n&&typeof n=="object"&&!Array.isArray(n)?r[c]=this.deepMerge(n,s):s!==void 0&&(r[c]=s)}return r}}const S="https://tong-api.workers.dev",R=/[\u4E00-\u9FFF]/,I=/[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FFF]/;class v{constructor(e){h(this,"baseUrl");this.baseUrl=e||S}containsKanji(e){return R.test(e)}containsJapanese(e){return I.test(e)}async translate(e,t,r){return(await this.post("/api/translate",{text:e,targetLang:t,sourceLang:r})).data}async romanize(e,t){if((t==="ja"||!t&&this.containsJapanese(e))&&this.containsKanji(e)){const a=await this.romanizeJapanese(e);return{romanized:a.romaji,hiragana:a.hiragana,katakana:a.katakana,segments:[]}}return(await this.post("/api/romanize",{text:e,language:t,includeSegments:!0})).data}async romanizeJapanese(e){return(await this.post("/api/romanize/japanese",{text:e})).data}async romanizeJapaneseBatch(e){return(await this.post("/api/romanize/japanese/batch",{texts:e})).data.results}async saveVocabulary(e){return(await this.post("/api/vocabulary",e)).data}async getVocabulary(e){const t=new URLSearchParams;return e&&t.set("language",e),(await this.get(`/api/vocabulary?${t}`)).data}async get(e){const t=await fetch(`${this.baseUrl}${e}`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!t.ok)throw new Error(`API error: ${t.status}`);return t.json()}async post(e,t){const r=await fetch(`${this.baseUrl}${e}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!r.ok)throw new Error(`API error: ${r.status}`);return r.json()}}const y=new P,L=new v,_=new A(y,L);chrome.runtime.onMessage.addListener((o,e,t)=>{var r;return console.log("[Background] Received message:",o.type,(r=e.tab)==null?void 0:r.url),_.handle(o,e).then(t).catch(a=>{console.error("[Background] Error handling message:",a),t({success:!1,error:a.message})}),!0});chrome.runtime.onInstalled.addListener(async o=>{console.log("[Background] Extension installed/updated:",o.reason),o.reason==="install"?(await y.setDefaultPreferences(),console.log("[Background] Default preferences set"),chrome.runtime.openOptionsPage()):o.reason==="update"&&console.log("[Background] Extension updated from:",o.previousVersion)});chrome.action.onClicked.addListener(async o=>{if(o.id)try{await chrome.tabs.sendMessage(o.id,{type:"TOGGLE_OVERLAY"})}catch{console.log("[Background] Could not toggle overlay - content script may not be loaded")}});chrome.tabs.onUpdated.addListener(async(o,e,t)=>{if(e.status!=="complete"||!t.url)return;[/youtube\.com\/watch/,/bilibili\.com\/video/].some(c=>c.test(t.url))&&console.log("[Background] Supported video page detected:",t.url)});console.log("[Background] Tong service worker started");
