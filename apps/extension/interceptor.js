(function(){"use strict";(function(){const u=new Set;let y=0;const f=window.XMLHttpRequest,I=f.prototype.open;f.prototype.open=function(t,e,...n){const o=typeof e=="string"?e:e.toString();return(o.includes("/api/timedtext")||o.includes("timedtext"))&&(this._pinpointUrl=o),I.call(this,t,e,...n)};const P=f.prototype.send;f.prototype.send=function(...t){return this._pinpointUrl&&this.addEventListener("load",function(){if(this.responseText&&this.responseText.length>0)try{const e=new URL(this._pinpointUrl),n=e.searchParams.get("lang")||"unknown",o=e.searchParams.get("fmt")||"xml";console.log("[Pinpoint Interceptor] Captured XHR caption:",n,o,this.responseText.length,"bytes"),u.add(n),window.dispatchEvent(new CustomEvent("pinpoint-caption-intercepted",{detail:{lang:n,data:this.responseText,format:o}}))}catch{}}),P.apply(this,t)};const T=window.fetch;window.fetch=async function(...t){var o;const e=typeof t[0]=="string"?t[0]:t[0]instanceof Request?t[0].url:((o=t[0])==null?void 0:o.toString())||"",n=await T.apply(this,t);if(e.includes("/api/timedtext")||e.includes("timedtext"))try{const c=await n.clone().text();if(c&&c.length>10){const r=new URL(e),s=r.searchParams.get("lang")||"unknown",l=r.searchParams.get("fmt")||"xml";console.log("[Pinpoint Interceptor] Captured fetch caption:",s,l,c.length,"bytes"),u.add(s),window.dispatchEvent(new CustomEvent("pinpoint-caption-intercepted",{detail:{lang:s,data:c,format:l}}))}}catch{}return n};function b(){if(!document.getElementById("pinpoint-temp-hide-cc")){const t=document.createElement("style");t.id="pinpoint-temp-hide-cc",t.textContent=`
        .ytp-caption-window-container { display: none !important; }
        .ytp-settings-menu { opacity: 0 !important; pointer-events: auto !important; }
      `,document.head.appendChild(t)}}function S(){setTimeout(()=>{var t;(t=document.getElementById("pinpoint-temp-hide-cc"))==null||t.remove()},200)}function v(){var o,i,c,r,s,l;const t=document.getElementById("movie_player");let e=[],n=[];try{e=((o=t==null?void 0:t.getOption)==null?void 0:o.call(t,"captions","tracklist"))||[]}catch{}try{const a=(i=t==null?void 0:t.getPlayerResponse)==null?void 0:i.call(t);n=((r=(c=a==null?void 0:a.captions)==null?void 0:c.playerCaptionsTracklistRenderer)==null?void 0:r.captionTracks)||[]}catch{}if(n.length===0)try{const a=window.ytInitialPlayerResponse;n=((l=(s=a==null?void 0:a.captions)==null?void 0:s.playerCaptionsTracklistRenderer)==null?void 0:l.captionTracks)||[]}catch{}return{playerTracks:e,fullTracks:n}}function h(t){const e=document.getElementById("movie_player");if(!e){console.warn("[Pinpoint Interceptor] No movie_player found");return}if(!document.querySelector(".ytp-subtitles-button")){console.warn("[Pinpoint Interceptor] No CC button found");return}try{e.loadModule("captions")}catch{}const{playerTracks:o,fullTracks:i}=v();console.log("[Pinpoint Interceptor] Player tracks:",o.map(c=>c.languageCode)),console.log("[Pinpoint Interceptor] Full tracks (inc ASR):",i.map(c=>c.languageCode)),C(t,o,i)}function C(t,e,n){const o=document.getElementById("movie_player"),i=document.querySelector(".ytp-subtitles-button");if(!o||!i)return;const c=i.getAttribute("aria-pressed")==="true";b(),c&&(console.log("[Pinpoint Interceptor] CC is on, turning off first..."),i.click()),setTimeout(()=>{if(t){let r=e.find(s=>s.languageCode===t);if(!r)try{r=(o.getOption("captions","tracklist")||[]).find(l=>l.languageCode===t),r&&console.log("[Pinpoint Interceptor] Found",t,"in refreshed player tracklist")}catch{}if(!r){const s=n.find(l=>l.languageCode===t);s&&(console.log("[Pinpoint Interceptor] Using full captionTrack object for",t,"kind:",s.kind||"unknown","hasBaseUrl:",!!s.baseUrl),r={...s})}if(r){console.log("[Pinpoint Interceptor] Setting track to:",t,"kind:",r.kind||"standard","vssId:",r.vssId||"none");try{o.setOption("captions","track",r)}catch{console.warn("[Pinpoint Interceptor] setOption failed for",t)}}else console.warn("[Pinpoint Interceptor] No track found for",t,"in any source")}console.log("[Pinpoint Interceptor] Turning CC on to trigger caption fetch..."),i.click(),g(()=>{!c&&i.getAttribute("aria-pressed")==="true"&&i.click(),S()},0,t)},400)}function g(t,e=0,n,o=!1){if(n?u.has(n):u.size>0){console.log("[Pinpoint Interceptor] Caption data captured successfully for:",n??"any"),t();return}if(e>40&&n&&!o){console.log("[Pinpoint Interceptor] CC toggle did not capture",n,"— trying settings menu..."),_(n).then(c=>{c?g(t,0,n,!0):(console.warn("[Pinpoint Interceptor] Settings menu fallback failed for:",n),t())});return}if(e>75){console.warn("[Pinpoint Interceptor] Timed out waiting for caption data:",n??"any"),t();return}setTimeout(()=>g(t,e+1,n,o),200)}function m(t){return new Promise(e=>setTimeout(e,t))}const w={ko:["korean","한국어"],ja:["japanese","日本語"],zh:["chinese","中文"],en:["english","영어"],vi:["vietnamese","tiếng việt"],th:["thai","ภาษาไทย"],id:["indonesian","bahasa indonesia"]};async function _(t){var n,o;const e=document.querySelector(".ytp-settings-button");if(!e)return!1;try{e.click(),await m(400);const i=document.querySelectorAll(".ytp-menuitem");let c=null;for(const d of i){const p=(((n=d.querySelector(".ytp-menuitem-label"))==null?void 0:n.textContent)||"").toLowerCase();if(p.includes("subtitle")||p.includes("자막")||p.includes("caption")||p.includes("cc")){c=d;break}}if(!c)return console.log("[Pinpoint Interceptor] No subtitles menu item found"),e.click(),!1;c.click(),await m(400);const r=document.querySelectorAll(".ytp-menuitem"),s=t.split("-")[0],l=w[s]||w[t]||[t];for(const d of r){const p=(((o=d.querySelector(".ytp-menuitem-label"))==null?void 0:o.textContent)||"").toLowerCase();if(l.some(x=>p.includes(x))||p.startsWith(t))return console.log("[Pinpoint Interceptor] Settings menu: selecting track:",p),d.click(),await m(300),e.click(),!0}console.log("[Pinpoint Interceptor] Settings menu: no track found for",t,"among",Array.from(r).map(d=>{var p;return(p=d.querySelector(".ytp-menuitem-label"))==null?void 0:p.textContent}).join(", "));const a=document.querySelector(".ytp-panel-back-button");return a&&a.click(),await m(200),e.click(),!1}catch(i){console.warn("[Pinpoint Interceptor] Settings menu error:",i);try{e.click()}catch{}return!1}}window.addEventListener("pinpoint-request-captions",t=>{var n;const e=(n=t.detail)==null?void 0:n.lang;console.log("[Pinpoint Interceptor] Caption request for:",e||"default"),e?u.delete(e):u.clear(),h(e)});function k(){if(!window.location.pathname.startsWith("/watch"))return;const t=++y;let e=0;const n=()=>{if(t!==y||(e++,e>60))return;const o=document.getElementById("movie_player");if(!o){setTimeout(n,500);return}let i=-1;try{i=o.getPlayerState()}catch{}if(i<1){setTimeout(n,500);return}console.log("[Pinpoint Interceptor] Auto-triggering (player state="+i+")"),h()};setTimeout(n,1500)}k(),document.addEventListener("yt-navigate-finish",()=>{window.location.pathname.startsWith("/watch")&&(u.clear(),setTimeout(()=>k(),1e3))}),console.log("[Pinpoint Interceptor] Interceptors installed (auto-trigger + passive capture)")})()})();
